name: API

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

env:
  CARGO_TERM_COLOR: always
  GH_TOKEN: ${{ github.token }}

jobs:
  test_linux:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    - name: Build
      run: cargo build --verbose
    - name: Run tests
      run: cargo test --verbose -- --test-threads=1

  test_windows:

    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v3
    - name: Build
      run: cargo build --verbose
    - name: Run tests
      run: cargo test --verbose -- --test-threads=1

  create_release:
    needs: [test_linux, test_windows]
    runs-on: ubuntu-latest

    outputs:
      RELEASE_VERSION: ${{ steps.extract_version.outputs.app_version }}
      RELEASE_ID: ${{ steps.get_release_id.outputs.id }}

    steps:
    - uses: actions/checkout@v3

    - name: Extract Version
      id: extract_version
      uses: dante-signal31/rust-app-version@v1.2.0
      with:
         cargo_toml_folder: ./

    - name: Create Release
      id: create_release
      run: gh release create "v${{ steps.extract_version.outputs.app_version }}" -t "v${{ steps.extract_version.outputs.app_version }}" -n "v${{ steps.extract_version.outputs.app_version }}"

    
    - name: Get release ID
      id: get_release_id
      uses: joutvhu/get-release@v1
      with:
        tag_name: ${{ steps.extract_version.outputs.app_version }}
      env:
        GITHUB_TOKEN: ${{ github.token }}

  package_and_upload_linux:
    needs: create_release
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      - uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: build
        run: ./build-linux.sh

      - name: package
        run: zip -r palantir-media-server-v${{ needs.create_release.outputs.RELEASE_VERSION }}-linux.zip build/

      - name: upload
        run: gh release upload ${{ needs.create_release.outputs.RELEASE_ID }} palantir-media-server-v${{ needs.create_release.outputs.RELEASE_VERSION }}-linux.zip

  package_and_upload_windows:
    needs: create_release
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v3
      - uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: build
        run: ./build-windows.bat

      - name: package
        run: zip -r palantir-media-server-v${{ needs.create_release.outputs.RELEASE_VERSION }}-win64.zip build/

      - name: upload
        run: gh release upload ${{ needs.create_release.outputs.RELEASE_ID }} palantir-media-server-v${{ needs.create_release.outputs.RELEASE_VERSION }}-linux.zip

  delete_release:
    if: failure()
    needs: [create_release, package_and_upload_linux, package_and_upload_windows]
    runs-on: ubuntu-latest

    steps:
      - name: Delete Release
        run: gh release delete ${{ needs.create_release.outputs.RELEASE_ID }} -y